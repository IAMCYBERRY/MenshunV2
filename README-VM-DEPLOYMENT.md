# Menshun PAM - VM Deployment Guide

This guide covers production deployment of Menshun PAM on virtual machines with simple commands like `make init`.

## Quick Start

### 1. Clone and Prepare
```bash
git clone <repository-url>
cd MenshunV2
git checkout dev/vm-optimization
```

### 2. Initialize VM (One Command!)
```bash
make init
```

This single command will:
- ✅ Check system requirements
- ✅ Install Docker and Docker Compose
- ✅ Create directory structure
- ✅ Configure environment settings
- ✅ Set up Nginx reverse proxy
- ✅ Generate SSL certificates
- ✅ Install systemd services
- ✅ Deploy the application

### 3. Access Your Menshun PAM
```bash
# Your Menshun PAM will be available at:
https://your-server-ip/
```

## Available Commands

### Deployment Commands
```bash
make init         # First-time setup (recommended)
make deploy       # Deploy/update application
make start        # Start all services
make stop         # Stop all services
make restart      # Restart all services
```

### Management Commands
```bash
make status       # Show service status
make logs         # Show application logs
make backup       # Create full system backup
make restore      # Restore from backup
make update       # Update to latest version
make clean        # Clean up unused resources
```

### Development Commands
```bash
make dev-start    # Start development environment
make dev-stop     # Stop development environment
```

### Utility Commands
```bash
make create-admin # Create superuser account
make shell        # Open Django shell
make db-shell     # Open database shell
make health-check # Run health check
make ssl-renew    # Renew SSL certificates
```

## Architecture

### Production Stack
- **Web Server**: Nginx (reverse proxy, SSL termination)
- **Application**: Django with Gunicorn WSGI server
- **Database**: PostgreSQL 15
- **Cache/Queue**: Redis 7
- **Task Queue**: Celery with Redis backend
- **Container Runtime**: Docker with Docker Compose

### Directory Structure
```
/opt/menshun/
├── data/          # Persistent data (PostgreSQL, Redis, static files)
├── logs/          # Application and system logs
├── backups/       # Automated backups
├── ssl/           # SSL certificates
└── config/        # Configuration files
```

## Configuration

### Environment Variables
All configuration is managed through `.env.production`:

```bash
# Basic Configuration
DEBUG=False
SECRET_KEY=<auto-generated>
ALLOWED_HOSTS=your-domain.com,your-ip

# Database
DATABASE_NAME=menshen_db
DATABASE_USER=postgres
DATABASE_PASSWORD=<auto-generated>

# Microsoft Entra ID
AZURE_TENANT_ID=your-tenant-id
AZURE_CLIENT_ID=your-client-id
AZURE_CLIENT_SECRET=your-client-secret

# Microsoft Sentinel (Optional)
SENTINEL_ENABLED=true
SENTINEL_WORKSPACE_ID=your-workspace-id
SENTINEL_DATA_COLLECTION_ENDPOINT=https://your-endpoint
```

### SSL Configuration
Three SSL options supported:

1. **Let's Encrypt** (Recommended for public domains)
   - Automatic certificate generation
   - Auto-renewal via cron
   - Free and trusted by browsers

2. **Self-Signed Certificate**
   - Generated automatically
   - Good for internal/development use
   - Browser warnings expected

3. **Existing Certificate**
   - Bring your own certificate files
   - Full control over certificate chain

## Services Management

### Systemd Integration
Menshun is integrated with systemd for automatic startup and management:

```bash
sudo systemctl start menshun.target     # Start all services
sudo systemctl stop menshun.target      # Stop all services
sudo systemctl status menshun.target    # Check status
sudo systemctl restart menshun-web      # Restart web application
```

### Available Services
- `menshun.target` - Main service group
- `menshun-web.service` - Web application
- `menshun-monitor.service` - Health monitoring
- `menshun-backup.timer` - Automated daily backups

### Log Management
Logs are automatically rotated and managed:
- **Application Logs**: `/opt/menshun/logs/`
- **Nginx Logs**: `/opt/menshun/logs/nginx/`
- **System Logs**: `journalctl -u menshun-web.service`

## Backup and Recovery

### Automated Backups
- **Schedule**: Daily at 2 AM (configurable)
- **Retention**: 30 days (configurable)
- **Components**: Database, configuration, media files, SSL certificates
- **Location**: `/opt/menshun/backups/`

### Manual Backup
```bash
make backup
# Creates: /opt/menshun/backups/menshun-backup-YYYYMMDD-HHMMSS.tar.gz
```

### Restore Process
```bash
make restore BACKUP_FILE=/path/to/backup.tar.gz
```

## Security Features

### Network Security
- **HTTPS Only**: Automatic HTTP to HTTPS redirect
- **HSTS**: HTTP Strict Transport Security enabled
- **Rate Limiting**: API endpoints protected
- **Firewall Ready**: Only necessary ports exposed

### Application Security
- **CSRF Protection**: Cross-site request forgery protection
- **XSS Protection**: Content Security Policy headers
- **Session Security**: Secure, HttpOnly, SameSite cookies
- **SQL Injection**: Django ORM protection

### System Security
- **Non-Root Containers**: All containers run as non-root users
- **Resource Limits**: Memory and CPU limits enforced
- **Secret Management**: Environment-based secrets
- **Log Sanitization**: Sensitive data filtered from logs

## Monitoring and Health Checks

### Built-in Health Checks
- **Application**: `/health/` endpoint
- **Database**: Connection and query tests
- **Redis**: Ping and memory checks
- **Nginx**: Process and response checks

### Performance Monitoring
```bash
make monitor      # Real-time system monitoring
make performance  # Performance metrics
```

### Integration Ready
- **Microsoft Sentinel**: Security event streaming
- **Sentry**: Error tracking and performance monitoring
- **Prometheus**: Metrics collection (optional)

## Updating

### Application Updates
```bash
git pull origin main
make update
```

### System Updates
```bash
# Update system packages
sudo apt update && sudo apt upgrade  # Ubuntu/Debian
sudo yum update                       # CentOS/RHEL

# Update Docker containers
make clean
make deploy
```

## Troubleshooting

### Common Issues

**Service Won't Start**
```bash
make status                    # Check service status
sudo journalctl -u menshun-web.service -f  # View logs
make health-check             # Run diagnostics
```

**SSL Certificate Issues**
```bash
./scripts/setup-ssl.sh       # Regenerate certificates
make ssl-renew               # Renew existing certificates
```

**Database Connection Issues**
```bash
make db-shell                # Test database connection
docker-compose -f docker-compose.prod.yml logs db  # Check database logs
```

**Performance Issues**
```bash
make performance             # Check performance metrics
make monitor                 # Real-time monitoring
```

### Log Locations
- **Application**: `/opt/menshun/logs/django.log`
- **Security**: `/opt/menshun/logs/security.log`
- **Nginx**: `/opt/menshun/logs/nginx/access.log`
- **System**: `journalctl -u menshun-web.service`

## Advanced Configuration

### Scaling
To handle higher load, adjust these settings in `.env.production`:
```bash
GUNICORN_WORKERS=8           # CPU cores * 2
GUNICORN_THREADS=4           # For I/O bound workloads
```

### External Database
To use an external PostgreSQL database:
```bash
DATABASE_HOST=your-db-server.com
DATABASE_PORT=5432
DATABASE_NAME=menshun_prod
DATABASE_USER=menshun_user
DATABASE_PASSWORD=secure_password
```

### Load Balancer Integration
For multiple servers behind a load balancer:
```bash
ALLOWED_HOSTS=lb.domain.com,server1.domain.com,server2.domain.com
SECURE_PROXY_SSL_HEADER=HTTP_X_FORWARDED_PROTO,https
```

## Support

### Getting Help
1. Check logs: `make logs`
2. Run health check: `make health-check`
3. Review configuration: `make show-config`
4. Check system status: `make status`

### Contributing
1. Create feature branch from `dev/vm-optimization`
2. Test with `make dev-start`
3. Submit pull request

## Security Considerations

### Production Checklist
- [ ] Change default passwords
- [ ] Configure Entra ID integration
- [ ] Set up SSL certificates
- [ ] Configure firewall rules
- [ ] Enable automated backups
- [ ] Set up monitoring alerts
- [ ] Review log retention policies
- [ ] Test disaster recovery

### Regular Maintenance
- Monitor disk space: `df -h`
- Check log files: `make logs`
- Review security logs: `/opt/menshun/logs/security.log`
- Update system packages regularly
- Rotate SSL certificates as needed
- Test backup restoration periodically

---

**Need help?** Check the troubleshooting section or create an issue in the repository.