# Session Summary — 2026-02-26

## Issues Fixed

### 1. FIELD_ENCRYPTION_KEY Not Reaching Docker Containers
**Problem:** `make init` failed with `[ERROR] FIELD_ENCRYPTION_KEY is not set` inside the container. The key was being written to `.env` by `setup-environment.sh` but was never forwarded into the containers because it wasn't listed in the service `environment:` blocks.

**Fix:** Added `- FIELD_ENCRYPTION_KEY=${FIELD_ENCRYPTION_KEY}` to the `web`, `celery`, and `celery-beat` service environment blocks in both:
- `docker-compose.prod.yml`
- `docker-compose.deploy.yml`

**Secondary fix:** Updated `scripts/setup-environment.sh` to detect an existing `.env` that is missing `FIELD_ENCRYPTION_KEY` (e.g. generated before this variable was introduced) and append it automatically before exiting, with a backup warning.

---

### 2. Systemd Service Using docker-compose v1 Binary
**Problem:** `menshun-web.service` was failing with `Unable to locate executable '/usr/local/bin/docker-compose'`. The server has Docker Compose v2 (plugin), which is invoked as `docker compose` not via a standalone binary.

**Fix:** Updated `scripts/install-systemd-services.sh` to replace all occurrences of `/usr/local/bin/docker-compose` with `/usr/bin/docker compose` in the generated service file `ExecStart`, `ExecStop`, `ExecReload`, and logrotate `postrotate` script.

---

### 3. Systemd Service Not Restarting After Reinstall
**Problem:** Re-running `make deploy` would overwrite the systemd service file on disk but not clear the previous failed state or restart the service, leaving it stuck in `failed`.

**Fix:** Added `systemctl reset-failed` and `systemctl restart` calls to the end of `scripts/install-systemd-services.sh` so a reinstall always brings the service up cleanly.

---

### 4. PostgreSQL Password Mismatch on Redeploy
**Problem:** After deleting and re-cloning the project, `make init` generated a new `DATABASE_PASSWORD` in `.env` but the Postgres data directory at `~/opt/menshun/data/postgres` persisted with the old password — causing Django to fail authentication.

**Resolution:** Wipe the old data directory before redeploying:
```bash
docker compose -f docker-compose.prod.yml down
sudo rm -rf ~/opt/menshun/data/postgres
mkdir -p ~/opt/menshun/data/postgres
make deploy
```

---

## New Feature: make purge

Added `scripts/purge.sh` and `make purge` target for a complete system wipe, enabling true fresh redeployments without provisioning a new server.

**Usage:**
```bash
make purge   # prompts: type PURGE to confirm
make init    # fresh deployment
```

**What it removes (8 steps):**
1. Docker containers and volumes
2. Project Docker images
3. Docker networks
4. Systemd services (`menshun-web`, `menshun-monitor`, `menshun-backup`, `menshun.target`)
5. Logrotate and tmpfiles config (`/etc/logrotate.d/menshun`, `/etc/tmpfiles.d/menshun.conf`)
6. Nginx site configuration
7. `~/opt/menshun/` — all data, logs, backups
8. `.env` file + dangling Docker resources

---

## Commits

| Hash | Description |
|---|---|
| `de10ad2` | Fix `FIELD_ENCRYPTION_KEY` not reaching Docker containers |
| `e1a97c0` | Fix systemd service using `docker-compose` v1 binary path |
| `7af747b` | Reset and restart systemd service after reinstalling |
| `4912f16` | Add `make purge` for complete system wipe and fresh redeploy |

---

## Key Reminders

- `make init` is for **first deployment only** — it runs all setup scripts including interactive `setup-environment.sh`
- `make deploy` is for **subsequent deploys/updates** — does not re-run environment setup
- `make purge` → `make init` is the correct sequence for a completely clean redeploy
- `FIELD_ENCRYPTION_KEY` must be backed up — losing it makes all vault passwords unrecoverable
- The Postgres data directory lives at `~/opt/menshun/data/postgres` — **outside** the project directory, so it survives `rm -rf MenshunV2`
