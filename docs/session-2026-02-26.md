# Session Summary — 2026-02-26 / 2026-02-27

## Issues Fixed

### 1. FIELD_ENCRYPTION_KEY Not Reaching Docker Containers
**Problem:** `make init` failed with `[ERROR] FIELD_ENCRYPTION_KEY is not set` inside the container. The key was being written to `.env` by `setup-environment.sh` but was never forwarded into the containers because it wasn't listed in the service `environment:` blocks.

**Fix:** Added `- FIELD_ENCRYPTION_KEY=${FIELD_ENCRYPTION_KEY}` to the `web`, `celery`, and `celery-beat` service environment blocks in both `docker-compose.prod.yml` and `docker-compose.deploy.yml`.

**Secondary fix:** Updated `scripts/setup-environment.sh` to detect an existing `.env` missing `FIELD_ENCRYPTION_KEY` and append it automatically before exiting.

---

### 2. Systemd Service Using docker-compose v1 Binary
**Problem:** `menshun-web.service` failed with `Unable to locate executable '/usr/local/bin/docker-compose'`. Server has Docker Compose v2 (`docker compose` plugin).

**Fix:** Replaced `/usr/local/bin/docker-compose` with `/usr/bin/docker compose` in `scripts/install-systemd-services.sh`.

---

### 3. Systemd Service Not Restarting After Reinstall
**Problem:** Re-running `make deploy` overwrote the systemd service file but didn't clear the failed state or restart it.

**Fix:** Added `systemctl reset-failed` and `systemctl restart` to the end of `scripts/install-systemd-services.sh`.

---

### 4. PostgreSQL Password Mismatch on Redeploy
**Problem:** After re-cloning, `make init` generated a new `DATABASE_PASSWORD` but the Postgres data directory at `~/opt/menshun/data/postgres` persisted with the old password.

**Resolution:**
```bash
docker compose -f docker-compose.prod.yml down
sudo rm -rf ~/opt/menshun/data/postgres
mkdir -p ~/opt/menshun/data/postgres
make deploy
```

---

### 5. ProtectHome=yes Blocking systemd WorkingDirectory
**Problem:** `menshun-web.service` had `ProtectHome=yes` which makes `/home` inaccessible, causing `CHDIR` failure when `WorkingDirectory=/home/menshun/MenshunV2`.

**Fix:** Removed `ProtectHome=yes` from both `menshun-web` and `menshun-monitor` service definitions in `scripts/install-systemd-services.sh`. `ProtectSystem=strict` and `NoNewPrivileges=yes` remain.

---

### 6. Docker Network Subnet Conflict
**Problem:** Hardcoded `172.25.0.0/16` subnet in all compose files caused `Pool overlaps with other one on this address space` errors when remnant networks from failed deployments still held the range.

**Fix:** Removed the `ipam/subnet` block from `docker-compose.prod.yml`, `docker-compose.deploy.yml`, and `docker-compose.simple.yml`. Docker now auto-assigns subnets. Added `docker network prune -f` to `scripts/purge.sh`.

---

### 7. Port Conflicts on Redeploy (5436, 6383)
**Problem:** `make deploy` didn't stop existing containers first, so leftover containers from failed attempts held ports and blocked new containers from starting.

**Fix:** Added `docker compose down --remove-orphans` + `docker stop/rm` of all containers at the start of the `deploy` Makefile target.

---

### 8. SSL Certificates Written to Wrong Directory
**Problem:** `scripts/setup-ssl.sh` created certs at `/opt/menshun/ssl` (system root) but `docker-compose.prod.yml` mounts `${HOME}/opt/menshun/ssl` into the nginx container — different paths. Nginx crash-looped with `cannot load certificate`.

**Additional issue:** The old script ran `sed -i` to inject `ssl_dhparam /etc/nginx/ssl/dhparam.pem;` into the live nginx config file. That file was never generated, causing nginx to fail on subsequent deployments even after the SSL fix.

**Fix:** Rewrote `scripts/setup-ssl.sh` to:
- Use `${HOME}/opt/menshun/ssl` (matches compose volume mount)
- Read domain from `.env` (not the non-existent `.env.production`)
- Auto-detect IP addresses and generate self-signed cert non-interactively
- Remove sudo from file ops (files are in user home)
- Remove dhparam generation (was injecting a broken nginx directive)

**Server workaround (remove injected dhparam line):**
```bash
sed -i '/ssl_dhparam/d' ~/MenshunV2/config/nginx/sites-available/menshun.conf
docker compose -f docker-compose.prod.yml restart nginx
```

**Generate SSL cert manually if needed:**
```bash
mkdir -p ~/opt/menshun/ssl
openssl req -new -newkey rsa:2048 -days 365 -nodes -x509 \
    -keyout ~/opt/menshun/ssl/menshun.key \
    -out ~/opt/menshun/ssl/menshun.crt \
    -subj "/CN=$(hostname -I | cut -d' ' -f1)"
chmod 600 ~/opt/menshun/ssl/menshun.key
```

---

### 9. Systemd ExecStartPost Health Check Wrong Port
**Problem:** `ExecStartPost` ran `curl -f http://localhost:8000/health/` on the host. The web container maps to host port **8003**, not 8000 — so it always failed and marked the service as failed even when containers were healthy.

**Fix:** Removed `ExecStartPost` entirely from the systemd service. Docker container healthchecks handle app-level health monitoring.

---

### 10. Systemd and make deploy Using Different Compose Project Names
**Problem:** The systemd service had `COMPOSE_PROJECT_NAME=menshun` set, causing it to try to start a *second* set of containers (`menshun-db-1` etc.) that competed for the same host ports as the `menshunv2` containers started by `make deploy`.

**Fix:** Removed `Environment=COMPOSE_PROJECT_NAME=menshun` and `Environment=COMPOSE_FILE=...` from the systemd service definition. Both now use the default project name (`menshunv2`, derived from the working directory).

**Server fix:**
```bash
sudo sed -i '/COMPOSE_PROJECT_NAME/d' /etc/systemd/system/menshun-web.service
sudo sed -i '/COMPOSE_FILE/d' /etc/systemd/system/menshun-web.service
sudo systemctl daemon-reload
sudo systemctl reset-failed menshun-web.service
sudo systemctl start menshun-web.service
```

---

## New Feature: make purge

Added `scripts/purge.sh` and `make purge` target for a complete system wipe.

```bash
make purge   # type PURGE to confirm
make init    # fresh deployment
```

Removes: containers/volumes/images, Docker networks, systemd services, logrotate/tmpfiles config, nginx config, `~/opt/menshun/` data, `.env`.

---

## Current Status (end of session)
- All containers running and healthy (`web`, `celery`, `celery-beat`, `db`, `redis`)
- Nginx still being resolved — needs the `ssl_dhparam` line removed from the live nginx config and SSL certs in the correct location
- Systemd `menshun-web.service` fix pushed but not yet applied on server (project name conflict fix)
- **Next step on server:** Apply fixes 8 and 10 above, then verify with `make status`

---

## All Commits This Session

| Hash | Description |
|---|---|
| `de10ad2` | Fix `FIELD_ENCRYPTION_KEY` not reaching Docker containers |
| `e1a97c0` | Fix systemd service using `docker-compose` v1 binary path |
| `7af747b` | Reset and restart systemd service after reinstalling |
| `4912f16` | Add `make purge` for complete system wipe and fresh redeploy |
| `b132299` | Add session summary doc |
| `09dafb5` | Fix systemd `ProtectHome` conflicting with home `WorkingDirectory` |
| `769ef52` | Fix Docker network subnet conflict and purge network cleanup |
| `fe26e48` | Stop existing containers before deploy to prevent port conflicts |
| `37834b4` | Force stop all containers before deploy to clear port conflicts |
| `893abde` | Fix `setup-ssl.sh` writing certs to wrong directory |
| `8371f1f` | Remove broken `ExecStartPost` health check from systemd service |
| `0aad425` | Fix systemd service project name conflict with `make deploy` |

---

## Key Reminders

- `make init` = first deployment only (runs all setup scripts interactively)
- `make deploy` = subsequent deploys/updates
- `make purge` → `make init` = completely clean redeploy
- `FIELD_ENCRYPTION_KEY` must be backed up — losing it makes all vault passwords unrecoverable
- Postgres data lives at `~/opt/menshun/data/postgres` — survives `rm -rf MenshunV2`
- SSL certs must be at `~/opt/menshun/ssl/` (not `/opt/menshun/ssl/`)
- Systemd service and `make deploy` must use the same Compose project name (`menshunv2`)
- The live nginx config at `~/MenshunV2/config/nginx/sites-available/menshun.conf` was modified in-place by the old `setup-ssl.sh` — the `ssl_dhparam` line must be removed manually on the server
